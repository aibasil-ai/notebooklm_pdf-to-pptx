## Context

目前缺乏針對 NotebookLM 產生 PDF 的可靠轉換流程，導致使用者無法直接在 PowerPoint 內編輯內容。NotebookLM PDF 通常具備固定版面、文字方塊與圖片元素，但缺少標準化的結構標記，必須透過解析與版面推斷建立可編輯的 PPTX。同時也需要提供網頁操作介面，讓非技術使用者在瀏覽器內完成上傳、查看進度並下載結果。設計上需要在保留版面與可編輯性之間取得平衡，並提供失敗時可接受的降級輸出。

## Goals / Non-Goals

**Goals:**
- 將 NotebookLM PDF 解析成可重用的中介版面模型（頁面尺寸、背景、文字區塊、圖片區塊）。
- 輸出可編輯的 PPTX，盡量保留元素位置、尺寸、層級與版面比例。
- 提供基本驗證與錯誤回報，確保轉換失敗可被診斷與追蹤。
- 提供網頁操作介面，支援上傳、轉換進度檢視與下載。
- 轉換流程完全在瀏覽器端完成，PDF 不上傳伺服器。

**Non-Goals:**
- 100% 字型與排版像素級還原（允許合理差異）。
- 完整支援任意 PDF 或複雜向量圖形／動畫。
- 進階互動（超連結、註解、動畫）之完整還原。
- 多使用者權限管理與登入系統。
- 後端處理與背景佇列服務。

## Decisions

1. 採用兩階段流程（PDF ingest → 中介版面模型 → PPTX render）。
   - 理由：降低耦合、可針對版面模型做測試與除錯。
   - 替代方案：直接將 PDF 元素映射成 PPTX（難以測試且不易擴充）。

2. PDF 解析採用具備文字與影像位置資訊的解析器（例如 PyMuPDF）。
   - 理由：可取得較完整的字元座標與影像邊界，適合版面還原。
   - 替代方案：pdfplumber/pdfminer（解析品質較依賴字元資訊，影像取得較弱）。

3. PPTX 產生使用高階 SDK（例如 python-pptx）。
   - 理由：減少直接操作 Open XML 的錯誤風險，提高可維護性。
   - 替代方案：直接輸出 Open XML 或採用其他語言 SDK（維護成本較高）。

4. 座標系統以 PDF points（72 dpi）轉換到 PPTX EMU，並以 PDF 頁面尺寸設定 slide 大小。
   - 理由：維持比例一致，避免縮放扭曲。
   - 替代方案：固定 16:9 或 4:3 slide（可能導致元素縮放或裁切）。

5. 背景處理策略：偵測整頁背景圖，轉為 slide background；其他圖片與文字以可編輯元素輸出。
   - 理由：保留可編輯性，同時維持原版面視覺。
   - 替代方案：整頁 rasterize 成單張圖片（易於實作但失去編輯能力）。

6. 失敗降級：當解析失敗或元素過於複雜時，提供整頁圖片輸出並標記警告。
   - 理由：確保輸出可用性，避免完全失敗。
   - 替代方案：直接失敗終止（使用者體驗較差）。

7. Web UI 採用純前端架構，轉換流程在 Web Worker 執行並透過訊息回報進度。
   - 理由：避免阻塞主執行緒，提升使用體驗且不依賴後端。
   - 替代方案：主執行緒同步轉換（易造成介面卡頓）。

8. PDF 解析採用瀏覽器端 PDF 解析器，並以中介模型與 PPTX 產生流程銜接。
   - 理由：不依賴系統套件，能在瀏覽器環境執行。
   - 替代方案：伺服器端解析（不符合純瀏覽器需求）。

9. 檔案與中介資料僅在瀏覽器端暫存（記憶體或 IndexedDB），完成後提供下載。
   - 理由：降低敏感資料外洩風險與儲存成本。
   - 替代方案：上傳到伺服器暫存（不符合純瀏覽器需求）。

## Risks / Trade-offs

- [文字框推斷不準確導致重疊或順序錯亂] → 以行分群與字距/行距閾值調整，並在必要時退回整頁圖片。
- [字型缺失導致視覺落差] → 建立字型對映表，缺失時使用預設字型並記錄警告。
- [圖片解析失敗或透明度問題] → 先以原始影像輸出，必要時轉成 PNG。
- [大型 PDF 轉換效能與記憶體壓力] → 逐頁處理、限制同時載入頁數、提供進度與中斷能力。
- [外部依賴更新造成行為差異] → 鎖定版本並建立固定樣本回歸測試。
- [惡意 PDF 內容造成解析風險] → 限制檔案大小與頁數，並在 Web Worker 中隔離處理。
- [同時進行多次轉換導致資源耗盡] → 限制同時轉換數量並提供中止機制。
- [瀏覽器資源不足導致當機或中斷] → 設定檔案大小上限與進度可中止。
- [瀏覽器相容性差異] → 限定支援瀏覽器版本並建立相容性測試。

## Migration Plan

1. 新增 NotebookLM PDF ingest 模組與中介版面模型定義。
2. 新增 PPTX render 模組，完成座標與尺寸轉換。
3. 建立 Web Worker 轉換流程與前端 UI（上傳、進度、下載）。
4. 建立樣本 PDF 測試集與轉換驗證（結構檢查 + 視覺快照）。
5. 發佈時可用 feature flag 控制啟用；若問題嚴重可關閉功能回退。

## Open Questions

- NotebookLM PDF 的實際版面與元素結構是否固定？需要多少樣本驗證？
- 允許的視覺誤差範圍（字距、行距、字型替換）為何？
- 是否需要支援多語系字型與特殊符號（例如 CJK、數學符號）？
- CLI/API 介面是否已有既定格式，或可新增專用參數？
- 是否需要輸出轉換報告（JSON）供後續 QA 或批次處理？
- Web UI 是否需要登入或權限控管？
- 轉換檔案與輸出檔案的保留時間與清理策略為何？
- 目標支援的瀏覽器版本與檔案大小上限為何？
